<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ if not .IsHome }}{{ .Title }} — {{ end }}{{ .Site.Title }}</title>
  <meta name="description" content="{{ with .Description }}{{ . }}{{ else }}{{ .Site.Params.description }}{{ end }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
  {{ block "head" . }}{{ end }}
</head>
<body{{ with .Params.body_class }} class="{{ . }}"{{ end }}>
  <div class="lattice-bg"></div>
  {{ partial "header.html" . }}
  <main>
    {{ block "main" . }}{{ end }}
  </main>
  {{ partial "footer.html" . }}

  <!-- SEARCH MODAL -->
  <div id="searchOverlay" class="search-overlay" aria-hidden="true">
    <div class="search-modal" role="dialog" aria-label="Search resources">
      <div class="search-input-row">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" style="flex-shrink:0;color:var(--ink-muted)"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input id="searchInput" class="search-input" type="text" placeholder="Search resources, topics, subjects…" autocomplete="off" spellcheck="false">
        <button class="search-esc" id="searchClose">Esc</button>
      </div>
      <div id="searchBody" class="search-body">
        <div id="searchEmpty" class="search-state">
          <p class="search-state-text">Start typing to search all resources</p>
          <div class="search-suggestions">
            <span class="search-suggestions-label">Try:</span>
            <button class="search-chip" onclick="triggerSearch('cells')">cells</button>
            <button class="search-chip" onclick="triggerSearch('algebra')">algebra</button>
            <button class="search-chip" onclick="triggerSearch('worksheet')">worksheet</button>
            <button class="search-chip" onclick="triggerSearch('grade 8')">grade 8</button>
          </div>
        </div>
        <div id="searchNone" class="search-state" style="display:none">
          <p class="search-state-text">No results for "<strong id="searchNoneTerm"></strong>"</p>
          <p class="search-state-sub">Try a subject name, topic, or grade level.</p>
        </div>
        <ul id="searchList" class="search-list" role="listbox"></ul>
      </div>
      <div class="search-footer">
        <span><kbd>↑</kbd><kbd>↓</kbd> navigate</span>
        <span><kbd>↵</kbd> open</span>
        <span><kbd>Esc</kbd> close</span>
      </div>
    </div>
  </div>

  <script>
  // NAV TOGGLE
  (function() {
    var t = document.querySelector('.nav-toggle');
    var p = document.querySelector('.nav-panel');
    if (!t || !p) return;
    t.addEventListener('click', function() {
      var open = p.classList.toggle('open');
      t.classList.toggle('open', open);
      t.setAttribute('aria-expanded', open);
    });
    p.querySelectorAll('a').forEach(function(a) {
      a.addEventListener('click', function() {
        p.classList.remove('open');
        t.classList.remove('open');
        t.setAttribute('aria-expanded', 'false');
      });
    });
  })();

  // SCROLL REVEAL
  (function() {
    var obs = new IntersectionObserver(function(entries) {
      entries.forEach(function(e) { if (e.isIntersecting) e.target.classList.add('visible'); });
    }, { threshold: 0.1 });
    document.querySelectorAll('.reveal').forEach(function(el) { obs.observe(el); });
  })();

  // SEARCH
  (function() {
    var idx      = null;
    var loading  = false;
    var active   = -1;
    var overlay  = document.getElementById('searchOverlay');
    var input    = document.getElementById('searchInput');
    var list     = document.getElementById('searchList');
    var empty    = document.getElementById('searchEmpty');
    var none     = document.getElementById('searchNone');

    function open() {
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      active = -1;
      reset();
      setTimeout(function() { input.focus(); }, 50);
      if (!idx && !loading) load();
    }

    function close() {
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      input.value = '';
    }

    function load() {
      loading = true;
      fetch('/index.json')
        .then(function(r) { return r.json(); })
        .then(function(d) { idx = d; loading = false; if (input.value.trim()) run(input.value); })
        .catch(function()  { idx = []; loading = false; });
    }

    function reset() {
      list.innerHTML      = '';
      empty.style.display = '';
      none.style.display  = 'none';
    }

    function score(item, terms) {
      var s = 0;
      var f = [
        { v: (item.title || '').toLowerCase(),                                        start: 100, hit: 60 },
        { v: ((item.subjects || []).join(' ')).toLowerCase(),                         start: 0,   hit: 45 },
        { v: ((item.resource_types || []).join(' ')).toLowerCase(),                   start: 0,   hit: 35 },
        { v: ((item.year_levels || []).join(' ')).toLowerCase(),                      start: 0,   hit: 30 },
        { v: ((item.tags || []).join(' ')).toLowerCase(),                             start: 0,   hit: 25 },
        { v: (item.description || '').toLowerCase(),                                  start: 0,   hit: 10 },
      ];
      terms.forEach(function(t) {
        f.forEach(function(field) {
          var i = field.v.indexOf(t);
          if (i === 0 && field.start) s += field.start;
          else if (i !== -1)          s += field.hit;
        });
      });
      return s;
    }

    function hl(str, terms) {
      if (!str) return '';
      var s = str.replace(/[&<>]/g, function(c) { return {'&':'&amp;','<':'&lt;','>':'&gt;'}[c]; });
      terms.forEach(function(t) {
        s = s.replace(new RegExp('(' + t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<mark>$1</mark>');
      });
      return s;
    }

    function color(subjects) {
      var s = ((subjects && subjects[0]) || '').toLowerCase();
      return { mathematics:'teal', biology:'sky', physics:'sky', chemistry:'rose',
               'earth science':'amber', 'space science':'amber' }[s] || 'teal';
    }

    function run(query) {
      var q = query.trim().toLowerCase();
      if (!q) { reset(); return; }
      if (!idx) return;
      var terms   = q.split(/\s+/).filter(Boolean);
      var results = idx
        .map(function(item) { return { item: item, s: score(item, terms) }; })
        .filter(function(r) { return r.s > 0; })
        .sort(function(a, b) { return b.s - a.s; })
        .slice(0, 10)
        .map(function(r) { return r.item; });

      empty.style.display = 'none';
      active = -1;

      if (!results.length) {
        list.innerHTML = '';
        none.style.display = '';
        document.getElementById('searchNoneTerm').textContent = query;
        return;
      }

      none.style.display = 'none';
      list.innerHTML = results.map(function(item) {
        var col  = color(item.subjects);
        var subj = (item.subjects && item.subjects[0]) || '';
        var type = (item.resource_types && item.resource_types[0]) || '';
        var yr   = (item.year_levels && item.year_levels[0]) || '';
        var desc = (item.description || '').slice(0, 115);
        return '<li class="sr-item" role="option" data-url="' + item.url + '" tabindex="-1">' +
          '<div class="sr-dot sr-dot--' + col + '"></div>' +
          '<div class="sr-body">' +
            '<div class="sr-title">' + hl(item.title, terms) + '</div>' +
            (desc ? '<div class="sr-desc">' + hl(desc, terms) + (item.description && item.description.length > 115 ? '…' : '') + '</div>' : '') +
            '<div class="sr-tags">' +
              (subj ? '<span class="sr-tag sr-tag--' + col + '">' + subj + '</span>' : '') +
              (type ? '<span class="sr-tag">' + type + '</span>' : '') +
              (yr   ? '<span class="sr-tag">' + yr + '</span>'   : '') +
            '</div>' +
          '</div>' +
          '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" style="flex-shrink:0;color:var(--ink-muted)"><polyline points="9 18 15 12 9 6"/></svg>' +
        '</li>';
      }).join('');

      list.querySelectorAll('.sr-item').forEach(function(el) {
        el.addEventListener('click', function() { window.location = el.dataset.url; close(); });
        el.addEventListener('mouseenter', function() { setActive(Array.from(list.children).indexOf(el)); });
      });
    }

    function setActive(i) {
      var items = list.querySelectorAll('.sr-item');
      if (!items.length) return;
      active = Math.max(0, Math.min(items.length - 1, i));
      items.forEach(function(el, j) { el.classList.toggle('active', j === active); });
      if (items[active]) items[active].scrollIntoView({ block: 'nearest' });
    }

    // Triggers
    document.getElementById('search-trigger').addEventListener('click', open);
    document.getElementById('searchClose').addEventListener('click', close);
    overlay.addEventListener('click', function(e) { if (e.target === overlay) close(); });
    input.addEventListener('input', function() { run(input.value); });

    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        overlay.classList.contains('open') ? close() : open();
        return;
      }
      if (!overlay.classList.contains('open')) return;
      if (e.key === 'Escape')    close();
      if (e.key === 'ArrowDown') { e.preventDefault(); setActive(active + 1); }
      if (e.key === 'ArrowUp')   { e.preventDefault(); setActive(active - 1); }
      if (e.key === 'Enter') {
        var items = list.querySelectorAll('.sr-item');
        if (active >= 0 && items[active]) { window.location = items[active].dataset.url; close(); }
      }
    });

    // Expose for hint chips
    window.triggerSearch = function(term) { input.value = term; run(term); input.focus(); };
  })();
  </script>
  {{ block "scripts" . }}{{ end }}
</body>
</html>
