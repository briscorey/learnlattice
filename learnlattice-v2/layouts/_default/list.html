{{ define "main" }}
{{ $featuredSubjects := .Site.Params.featured_subjects }}
{{ $subjectLookup := newScratch }}
{{ range $featuredSubjects }}
  {{ $subjectLookup.Set (lower .title) . }}
{{ end }}
{{ $subjectMeta := dict }}
{{ if and .IsNode (eq .Data.Singular "subject") }}
  {{ with $subjectLookup.Get (lower .Title) }}
    {{ $subjectMeta = . }}
  {{ end }}
{{ end }}

{{ if and $subjectMeta (gt (len $subjectMeta) 0) }}
<section class="page-hero page-hero-subject" data-color="{{ index $subjectMeta "color" }}">
  <div class="page-hero-copy">
    <div class="page-hero-kicker">Subject Collection</div>
    <h1>{{ .Title }}</h1>
    {{ with .Description }}<p>{{ . }}</p>{{ end }}
    {{ with index $subjectMeta "audience" }}<div class="page-hero-note">{{ . }}</div>{{ end }}
  </div>
  <div class="page-hero-media">
    {{ with index $subjectMeta "video" }}
    <video class="page-hero-video" autoplay muted loop playsinline poster="{{ index $subjectMeta "poster" }}">
      <source src="{{ . }}" type="video/mp4">
    </video>
    {{ else }}
      {{ with index $subjectMeta "image" }}
      <img src="{{ . }}" alt="{{ $.Title }} subject artwork">
      {{ end }}
    {{ end }}
  </div>
</section>
{{ else if and .IsNode (eq .Data.Singular "year_level") }}
<section class="page-hero page-hero-subject" data-color="teal">
  <div class="page-hero-copy">
    <div class="page-hero-kicker">BC Curriculum Collection</div>
    <h1>{{ .Title }}</h1>
    {{ with .Description }}<p>{{ . }}</p>{{ end }}
    <div class="page-hero-note">Browse grade-level unit plans alongside companion worksheets, labs, and inquiry packs connected to MYP criteria.</div>
  </div>
  <div class="page-hero-media">
    <img src="/img/topics/mathematics.svg" alt="{{ .Title }} curriculum artwork">
  </div>
</section>
{{ else }}
<div class="page-header">
  <h1>{{ .Title }}</h1>
  {{ with .Description }}<p>{{ . }}</p>{{ end }}
</div>
{{ end }}

{{ partial "topic-pathways.html" (dict
  "page" .
  "mode" "compact"
  "headline" "Topic Branches"
  "copy" "These branches expand this topic into connected investigations, modelling moves, and assessment pathways."
) }}

<section class="section">
  {{ if and (eq .Section "year-levels") (eq .Title "BC Curriculum Grades 6-9") }}
  {{ $gradePages := slice
    (.Site.GetPage "/year-levels/bc-grade-6")
    (.Site.GetPage "/year-levels/bc-grade-7")
    (.Site.GetPage "/year-levels/bc-grade-8")
    (.Site.GetPage "/year-levels/bc-grade-9")
  }}
  <div class="taxonomy-grid">
    {{ range $gradePages }}
      {{ if . }}
      {{ $count := len (where (where $.Site.RegularPages "Section" "resources") "Params.year_levels" "intersect" (slice .Title)) }}
      <a class="taxonomy-card" href="{{ .RelPermalink }}">
        <div class="taxonomy-card-count">{{ $count }} resources</div>
        <h2>{{ .Title }}</h2>
        <p>{{ .Description | default "Browse this collection of inquiry-based resources." }}</p>
      </a>
      {{ end }}
    {{ end }}
  </div>
  {{ else }}
  {{ $pages := .RegularPages.ByDate.Reverse }}
  {{ if and (eq .Section "year-levels") (ne .Title "BC Curriculum Grades 6-9") }}
    {{ $pages = where (where .Site.RegularPages "Section" "resources") "Params.year_levels" "intersect" (slice .Title) }}
  {{ else if and .IsSection (gt (len .Pages) 0) }}
    {{ $pages = .Pages.ByDate.Reverse }}
  {{ end }}

  {{ if $pages }}
  <div class="resources-grid">
    {{ range $pages }}
      {{ if eq .Section "resources" }}
        {{ partial "resource-card.html" . }}
      {{ end }}
    {{ end }}
  </div>
  {{ else }}
  <p style="color: var(--ink-muted); font-weight: 300;">No resources found in this category yet. Check back soon!</p>
  {{ end }}
  {{ end }}
</section>

{{ end }}
